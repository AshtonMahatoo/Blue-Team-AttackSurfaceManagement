# SP101 ASM - Alerts Configuration
# Version: 1.1.0

# Global alert settings
global:
  enabled: true
  alert_prefix: "[SP101-ASM]"
  environment: "${ENVIRONMENT:-production}"
  timezone: "UTC"
  
  # Alert deduplication
  deduplication:
    enabled: true
    window_minutes: 60
    group_by_fields:
      - "asset_id"
      - "vulnerability_id"
      - "severity"

# Email Alerting
email:
  enabled: true
  provider: "smtp"  # smtp, sendgrid, aws_ses
  
  # SMTP Configuration
  smtp:
    host: "${SMTP_HOST:-smtp.gmail.com}"
    port: "${SMTP_PORT:-587}"
    username: "${SMTP_USERNAME}"
    password: "${SMTP_PASSWORD}"
    use_tls: true
    use_ssl: false
    timeout: 30
    
  # Email Templates
  templates:
    critical_alert:
      subject: "${alert_prefix} CRITICAL: {severity} vulnerability detected on {asset}"
      body: |
        <!DOCTYPE html>
        <html>
        <head><style>body{font-family:Arial,sans-serif;}</style></head>
        <body>
          <h2> CRITICAL SECURITY ALERT</h2>
          <p><strong>Asset:</strong> {asset_hostname} ({asset_ip})</p>
          <p><strong>Vulnerability:</strong> {vulnerability_name}</p>
          <p><strong>CVSS Score:</strong> {cvss_score}</p>
          <p><strong>Description:</strong><br>{description}</p>
          <p><strong>Remediation:</strong><br>{remediation}</p>
          <p><strong>Discovered:</strong> {discovery_time}</p>
          <hr>
          <p><small>Generated by SP101 ASM Platform</small></p>
        </body>
        </html>
    
    new_asset:
      subject: "${alert_prefix} NEW: Asset discovered: {asset}"
      body: "New asset discovered:\n- IP: {ip}\n- Hostname: {hostname}\n- Type: {type}\n- Risk Score: {risk_score}"
      
    daily_summary:
      subject: "${alert_prefix} DAILY: Security Summary for {date}"
      body: "Daily Security Summary:\n\nTotal Assets: {total_assets}\nNew Assets: {new_assets}\nCritical Vulns: {critical_vulns}\nHigh Vulns: {high_vulns}"
  
  # Recipient Groups
  recipients:
    security_team:
      - "security-team@example.com"
      - "soc@example.com"
      
    management:
      - "cio@example.com"
      - "cto@example.com"
      
    developers:
      - "devops@example.com"
      - "platform-team@example.com"
  
  # Routing Rules
  routing:
    critical_vulnerabilities: "security_team,management"
    new_assets: "security_team"
    daily_summary: "security_team,management"
    compliance_violations: "security_team,management,compliance"

# Slack Integration
slack:
  enabled: false
  webhook_url: "${SLACK_WEBHOOK_URL}"
  channel: "#security-alerts"
  username: "SP101-ASM-Bot"
  icon_emoji: ":shield:"
  
  # Message templates
  templates:
    critical: |
       *CRITICAL ALERT* 
      *Asset:* {asset}
      *Vulnerability:* {vulnerability}
      *CVSS:* {cvss_score}
      *Link:* {dashboard_url}
      
    warning: |
      *SECURITY WARNING*
      *Asset:* {asset}
      *Issue:* {issue}
      *Risk:* {risk_level}
      
    info: |
       *Security Update*
      *Message:* {message}
  
  # Formatting
  format: "mrkdwn"  # mrkdwn, plain_text
  color_coding: true
  include_links: true
  dashboard_url: "https://graylog.example.com"

# Microsoft Teams Integration
teams:
  enabled: false
  webhook_url: "${TEAMS_WEBHOOK_URL}"
  
  cards:
    critical:
      themeColor: "FF0000"
      title: "CRITICAL: {severity} vulnerability detected"
      sections:
        - facts:
            - name: "Asset"
              value: "{asset}"
            - name: "Vulnerability"
              value: "{vulnerability}"
            - name: "CVSS Score"
              value: "{cvss_score}"
          potentialAction:
            - "@type": "OpenUri"
              name: "View in Dashboard"
              targets:
                - os: "default"
                  uri: "{dashboard_url}"

# PagerDuty Integration
pagerduty:
  enabled: false
  api_key: "${PAGERDUTY_API_KEY}"
  service_id: "${PAGERDUTY_SERVICE_ID}"
  
  events:
    critical:
      severity: "critical"
      component: "asm-platform"
      group: "security"
      class: "vulnerability"
      
    warning:
      severity: "warning"
      component: "asm-platform"
      group: "security"
      class: "anomaly"

# Webhook Integration (Generic)
webhooks:
  enabled: false
  
  endpoints:
    security_automation:
      url: "${WEBHOOK_URL}"
      method: "POST"
      headers:
        Authorization: "Bearer ${WEBHOOK_TOKEN}"
        Content-Type: "application/json"
      timeout: 10
      retry_attempts: 3
      
    siem_integration:
      url: "${SIEM_WEBHOOK_URL}"
      method: "POST"
      format: "cef"  # CEF, LEEF, JSON
      mapping:
        deviceVendor: "SP101-ASM"
        deviceProduct: "AttackSurfaceManagement"
        deviceVersion: "1.0"

# Alert Thresholds
thresholds:
  # Vulnerability severity thresholds
  vulnerabilities:
    critical:
      cvss_score: 9.0
      immediate_alert: true
      channels: ["email", "slack", "pagerduty"]
      escalation_minutes: 15
      
    high:
      cvss_score: 7.0
      alert_delay_minutes: 30
      channels: ["email", "slack"]
      
    medium:
      cvss_score: 4.0
      daily_summary: true
      channels: ["email"]
      
    low:
      cvss_score: 0.1
      weekly_summary: true
      channels: []

  # Asset discovery thresholds
  assets:
    new_external_asset:
      immediate_alert: true
      channels: ["email", "slack"]
      
    risk_score_change:
      threshold: 3.0
      channels: ["email"]
      
    asset_disappearance:
      days_missing: 7
      channels: ["email"]

  # Compliance thresholds
  compliance:
    pci_dss_violation:
      immediate_alert: true
      channels: ["email", "pagerduty"]
      
    hipaa_violation:
      immediate_alert: true
      channels: ["email", "pagerduty"]
      
    gdpr_violation:
      immediate_alert: true
      channels: ["email", "management"]

  # Performance thresholds
  performance:
    scan_failure_rate:
      threshold_percent: 20
      window_minutes: 60
      channels: ["email"]
      
    database_latency:
      threshold_ms: 1000
      channels: ["email"]
      
    queue_backlog:
      threshold_count: 1000
      channels: ["email"]

# Alert Suppression Rules
suppression:
  enabled: true
  
  rules:
    - name: "office_hours_only"
      condition: "time.hour < 9 or time.hour > 17"
      action: "delay"
      delay_until: "next 9:00"
      exclude_severities: ["critical"]
      
    - name: "weekend_suppression"
      condition: "time.weekday in ['saturday', 'sunday']"
      action: "suppress"
      exclude_severities: ["critical"]
      
    - name: "maintenance_window"
      condition: "asset.tags contains 'maintenance'"
      action: "suppress"
      
    - name: "test_environment"
      condition: "environment == 'test'"
      action: "suppress"
      channels: ["pagerduty"]

# Escalation Policies
escalation:
  enabled: true
  
  policies:
    critical_vulnerability:
      initial_alert: ["email", "slack"]
      after_30_minutes: ["pagerduty"]
      after_2_hours: ["sms", "phone_call"]
      after_24_hours: ["management_email"]
      
    platform_down:
      initial_alert: ["pagerduty"]
      after_5_minutes: ["sms"]
      after_15_minutes: ["phone_call"]
      
  # Contact methods
  contacts:
    primary_oncall:
      email: "oncall-primary@example.com"
      phone: "+1234567890"
      slack: "@primary_oncall"
      
    secondary_oncall:
      email: "oncall-secondary@example.com"
      phone: "+1234567891"
      slack: "@secondary_oncall"
      
    security_manager:
      email: "security-manager@example.com"
      phone: "+1234567892"

# Alert Templates
templates:
  # Field mappings for alert templates
  field_mappings:
    asset: "{hostname} ({ip})"
    vulnerability: "{cve_id}: {title}"
    cvss_score: "{cvss_score}/10"
    dashboard_url: "https://graylog.example.com/search?q=asset:{ip}"
    remediation: "{remediation or 'Please check vulnerability database'}"
    
  # Time formatting
  time_format: "%Y-%m-%d %H:%M:%S %Z"
  date_format: "%Y-%m-%d"
  
  # Severity icons
  severity_icons:
    critical: "ðŸ”´"
    high: "ðŸŸ "
    medium: "ðŸŸ¡"
    low: "ðŸŸ¢"
    info: "ðŸ”µ"

# Alert Storage
storage:
  enabled: true
  
  database:
    table_name: "alerts"
    retention_days: 90
    archive_after_days: 30
    
  # File storage for backup
  file:
    enabled: true
    directory: "/var/log/asm/alerts"
    rotation:
      max_size_mb: 100
      backup_count: 10
      compression: "gzip"
      
  # Export options
  export:
    enabled: true
    formats: ["json", "csv"]
    schedule: "0 2 * * *"  # Daily at 2 AM
    destination: "/var/backups/asm/alerts"

# Testing and Debugging
testing:
  enabled: false
  
  test_alerts:
    - type: "critical_vulnerability"
      asset: "test-server.example.com"
      ip: "192.168.1.100"
      vulnerability: "CVE-2023-12345"
      cvss_score: 9.8
      
    - type: "new_asset"
      ip: "203.0.113.50"
      hostname: "new-web-server.example.com"
      type: "web_server"
      
  # Alert simulation
  simulate:
    enabled: false
    rate_per_hour: 1
    include_severities: ["critical", "high", "medium"]
    
  # Dry-run mode
  dry_run:
    enabled: false
    log_alerts: true
    skip_channels: ["pagerduty", "sms"]